<Page
    x:Class="OpticaPro.Views.PatientHistoryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:OpticaPro.Models"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Page.Resources>
        <SolidColorBrush x:Key="BrandColor" Color="#0078D7"/>
        <SolidColorBrush x:Key="BrandLightColor" Color="#EDF5FD"/>
        <SolidColorBrush x:Key="SuccessColor" Color="#107C10"/>
        <SolidColorBrush x:Key="WarningColor" Color="#D83B01"/>
        <SolidColorBrush x:Key="SubtletyColor" Color="#646464"/>
        <SolidColorBrush x:Key="BorderBrush" Color="#E0E0E0"/>

        <ThemeShadow x:Key="SharedShadow"/>

        <Style x:Key="CardStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="CornerRadius" Value="12"/>
            <Setter Property="Margin" Value="0,0,0,24"/>
            <Setter Property="Shadow" Value="{StaticResource SharedShadow}"/>
        </Style>

        <Style x:Key="HeaderTitle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}"/>
            <Setter Property="Margin" Value="0,20,0,12"/>
        </Style>

        <Style x:Key="DetailLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="11"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource SubtletyColor}"/>
            <Setter Property="Opacity" Value="0.8"/>
            <Setter Property="Margin" Value="0,0,0,2"/>
        </Style>

        <Style x:Key="DetailValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="15"/>
            <Setter Property="Foreground" Value="{ThemeResource TextFillColorPrimaryBrush}"/>
            <Setter Property="TextWrapping" Value="Wrap"/>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="Height" Value="70"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}"/>
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="HorizontalContentAlignment" Value="Left"/>
        </Style>

        <Style x:Key="RefractionBox" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource LayerFillColorDefaultBrush}"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="MinWidth" Value="55"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>
    </Page.Resources>

    <Page.KeyboardAccelerators>
        <KeyboardAccelerator Key="Escape" Invoked="OnEscapeInvoked"/>
    </Page.KeyboardAccelerators>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <Border Grid.Row="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1" Padding="24,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Button Click="Back_Click" Style="{StaticResource NavigationBackButtonNormalStyle}" Margin="0,0,16,0" ToolTipService.ToolTip="Volver"/>

                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                    <TextBlock Text="HISTORIA CLÍNICA" FontSize="10" FontWeight="Bold" Foreground="{StaticResource BrandColor}" CharacterSpacing="50" Opacity="0.8"/>
                    <TextBlock Text="{x:Bind CurrentPatient.FullName, Mode=OneWay}" FontSize="18" FontWeight="Bold" Margin="0,2,0,0"/>
                </StackPanel>

                <Button Grid.Column="2" Click="Edit_Click" Background="Transparent" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="4" Padding="12,6">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE70F;" FontSize="14"/>
                        <TextBlock Text="Editar Datos" FontWeight="SemiBold" FontSize="13"/>
                    </StackPanel>
                </Button>
            </Grid>
        </Border>

        <ScrollViewer Grid.Row="1" Padding="24,32">
            <StackPanel MaxWidth="1200" HorizontalAlignment="Stretch" Spacing="0">

                <Border Style="{StaticResource CardStyle}" BorderBrush="{StaticResource BrandColor}" BorderThickness="0,4,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Grid Grid.Row="0" Padding="24">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <PersonPicture Initials="{x:Bind CurrentPatient.Initials, Mode=OneWay}" Height="80" Width="80" Margin="0,0,24,0"/>

                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Spacing="4">
                                <TextBlock Text="{x:Bind CurrentPatient.FullName, Mode=OneWay}" FontSize="26" FontWeight="Bold" Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                                <StackPanel Orientation="Horizontal" Spacing="12">
                                    <Border Background="{StaticResource BrandLightColor}" CornerRadius="4" Padding="8,2">
                                        <TextBlock Text="{x:Bind CurrentPatient.Status, Mode=OneWay}" Foreground="{StaticResource BrandColor}" FontWeight="Bold" FontSize="12"/>
                                    </Border>
                                    <TextBlock Text="•" Foreground="{StaticResource SubtletyColor}" VerticalAlignment="Center"/>
                                    <TextBlock Text="{x:Bind CurrentPatient.Occupation, Mode=OneWay}" Foreground="{StaticResource SubtletyColor}" FontSize="14" VerticalAlignment="Center"/>
                                </StackPanel>
                            </StackPanel>

                            <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right" Background="{ThemeResource LayerFillColorDefaultBrush}" Padding="12" CornerRadius="8">
                                <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,0,0,4">
                                    <FontIcon Glyph="&#xE787;" FontSize="14" Foreground="{StaticResource BrandColor}"/>
                                    <TextBlock Text="ÚLTIMA VISITA" FontSize="11" FontWeight="Bold" Foreground="{StaticResource SubtletyColor}"/>
                                </StackPanel>
                                <TextBlock Text="{x:Bind CurrentPatient.LastVisit, Mode=OneWay}" FontSize="14" FontWeight="SemiBold" HorizontalAlignment="Right"/>
                            </StackPanel>
                        </Grid>

                        <MenuFlyoutSeparator Grid.Row="1" Margin="0"/>

                        <Grid Grid.Row="2" Padding="24" Background="{ThemeResource LayerFillColorDefaultBrush}" CornerRadius="0,0,12,12">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="1.2*"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Spacing="16">
                                <StackPanel>
                                    <TextBlock Text="CÉDULA / DNI" Style="{StaticResource DetailLabel}"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE8F2;" FontSize="14" Foreground="{StaticResource BrandColor}"/>
                                        <TextBlock Text="{x:Bind CurrentPatient.Dni, Mode=OneWay}" Style="{StaticResource DetailValue}"/>
                                    </StackPanel>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="EDAD" Style="{StaticResource DetailLabel}"/>
                                    <TextBlock Text="{x:Bind CurrentPatient.Age, Mode=OneWay}" Style="{StaticResource DetailValue}">
                                        <Run Text=" Años"/>
                                    </TextBlock>
                                </StackPanel>
                            </StackPanel>

                            <Rectangle Grid.Column="1" Width="1" Fill="{StaticResource BorderBrush}" Margin="20,0"/>

                            <StackPanel Grid.Column="2" Spacing="16">
                                <StackPanel>
                                    <TextBlock Text="TELÉFONO" Style="{StaticResource DetailLabel}"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE717;" FontSize="14" Foreground="{StaticResource BrandColor}"/>
                                        <TextBlock Text="{x:Bind CurrentPatient.Phone, Mode=OneWay}" Style="{StaticResource DetailValue}"/>
                                    </StackPanel>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="CORREO ELECTRÓNICO" Style="{StaticResource DetailLabel}"/>
                                    <TextBlock Text="{x:Bind CurrentPatient.Email, Mode=OneWay}" Style="{StaticResource DetailValue}" FontSize="14"/>
                                </StackPanel>
                            </StackPanel>

                            <Rectangle Grid.Column="3" Width="1" Fill="{StaticResource BorderBrush}" Margin="20,0"/>

                            <StackPanel Grid.Column="4" Spacing="16">
                                <StackPanel>
                                    <TextBlock Text="CIUDAD" Style="{StaticResource DetailLabel}"/>
                                    <StackPanel Orientation="Horizontal" Spacing="8">
                                        <FontIcon Glyph="&#xE81D;" FontSize="14" Foreground="{StaticResource BrandColor}"/>
                                        <TextBlock Text="{x:Bind CurrentPatient.City, Mode=OneWay}" Style="{StaticResource DetailValue}" FontWeight="SemiBold"/>
                                    </StackPanel>
                                </StackPanel>
                                <StackPanel>
                                    <TextBlock Text="DIRECCIÓN" Style="{StaticResource DetailLabel}"/>
                                    <TextBlock Text="{x:Bind CurrentPatient.Address, Mode=OneWay}" Style="{StaticResource DetailValue}" MaxLines="2" TextTrimming="CharacterEllipsis"/>
                                </StackPanel>
                            </StackPanel>
                        </Grid>
                    </Grid>
                </Border>

                <TextBlock Text="Acciones Rápidas" Style="{StaticResource HeaderTitle}"/>
                <Grid ColumnSpacing="12" Margin="0,0,0,32">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Click="NewExam_Click" Style="{StaticResource ActionButton}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Background="#F3E5F5" Width="40" Height="40" CornerRadius="20" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE74C;" Foreground="#8E24AA" FontSize="18"/>
                            </Border>
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0,0,0" Spacing="2">
                                <TextBlock Text="Nuevo Examen" FontWeight="Bold" FontSize="13"/>
                                <TextBlock Text="Refracción" FontSize="11" Foreground="{StaticResource SubtletyColor}"/>
                            </StackPanel>
                        </Grid>
                    </Button>

                    <Button Grid.Column="1" Click="NewOrder_Click" Style="{StaticResource ActionButton}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Background="#E3F2FD" Width="40" Height="40" CornerRadius="20" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE710;" Foreground="{StaticResource BrandColor}" FontSize="18"/>
                            </Border>
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0,0,0" Spacing="2">
                                <TextBlock Text="Nuevo Pedido" FontWeight="Bold" FontSize="13"/>
                                <TextBlock Text="Venta Lentes" FontSize="11" Foreground="{StaticResource SubtletyColor}"/>
                            </StackPanel>
                        </Grid>
                    </Button>

                    <Button Grid.Column="2" Click="ViewPayments_Click" Style="{StaticResource ActionButton}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Background="#E8F5E9" Width="40" Height="40" CornerRadius="20" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE8C7;" Foreground="{StaticResource SuccessColor}" FontSize="18"/>
                            </Border>
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0,0,0" Spacing="2">
                                <TextBlock Text="Ver Pagos" FontWeight="Bold" FontSize="13"/>
                                <TextBlock Text="Deudas" FontSize="11" Foreground="{StaticResource SubtletyColor}"/>
                            </StackPanel>
                        </Grid>
                    </Button>

                    <Button Grid.Column="3" Click="NewAppointment_Click" Style="{StaticResource ActionButton}">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <Border Background="#FFF3E0" Width="40" Height="40" CornerRadius="20" VerticalAlignment="Center">
                                <FontIcon Glyph="&#xE787;" Foreground="{StaticResource WarningColor}" FontSize="18"/>
                            </Border>
                            <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="12,0,0,0" Spacing="2">
                                <TextBlock Text="Nueva Cita" FontWeight="Bold" FontSize="13"/>
                                <TextBlock Text="Agendar" FontSize="11" Foreground="{StaticResource SubtletyColor}"/>
                            </StackPanel>
                        </Grid>
                    </Button>
                </Grid>

                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE787;" Foreground="{StaticResource WarningColor}" FontSize="18" VerticalAlignment="Center"/>
                        <TextBlock Text="Citas Programadas" Style="{StaticResource HeaderTitle}" Margin="0"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="No hay citas pendientes" Foreground="{StaticResource SubtletyColor}" Visibility="{x:Bind ShowIfEmpty(AppointmentHistory.Count), Mode=OneWay}" VerticalAlignment="Center"/>
                </Grid>

                <ListView ItemsSource="{x:Bind AppointmentHistory, Mode=OneWay}" SelectionMode="None" Margin="0,0,0,24">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0,0,0,8"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:Appointment">
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="12">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Date}" FontSize="14" FontWeight="Bold" Foreground="{StaticResource WarningColor}" HorizontalAlignment="Center"/>
                                        <TextBlock Text="{x:Bind Time}" FontSize="12" Foreground="{StaticResource SubtletyColor}" HorizontalAlignment="Center"/>
                                    </StackPanel>

                                    <Rectangle Grid.Column="1" Width="1" Fill="{ThemeResource CardStrokeColorDefaultBrush}" Height="30"/>

                                    <StackPanel Grid.Column="2" VerticalAlignment="Center">
                                        <TextBlock Text="{x:Bind Reason}" FontWeight="SemiBold" FontSize="14"/>
                                        <TextBlock Text="Consulta General" FontSize="12" Foreground="{StaticResource SubtletyColor}"/>
                                    </StackPanel>

                                    <Border Grid.Column="3" Background="#FFF3E0" CornerRadius="4" Padding="8,4">
                                        <TextBlock Text="{x:Bind Status}" Foreground="{StaticResource WarningColor}" FontSize="11" FontWeight="Bold"/>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE9D9;" Foreground="{StaticResource BrandColor}" FontSize="18" VerticalAlignment="Center"/>
                        <TextBlock Text="Historial Clínico (Refracción)" Style="{StaticResource HeaderTitle}" Margin="0"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="Sin registros" Foreground="{StaticResource SubtletyColor}" Visibility="{x:Bind ShowIfEmpty(CurrentPatient.ExamHistory.Count), Mode=OneWay}" VerticalAlignment="Center"/>
                </Grid>

                <ListView ItemsSource="{x:Bind CurrentPatient.ExamHistory, Mode=OneWay}" SelectionMode="None" Margin="0,0,0,24">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0,0,0,16"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:ClinicalExam">
                            <Border Style="{StaticResource CardStyle}" Margin="0">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <Grid Grid.Row="0" Background="{ThemeResource LayerFillColorDefaultBrush}" Padding="16,10" CornerRadius="12,12,0,0" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="0,0,0,1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Orientation="Horizontal" Spacing="12">
                                            <Border Background="{StaticResource BrandColor}" CornerRadius="4" Padding="6">
                                                <FontIcon Glyph="&#xE74C;" Foreground="White" FontSize="12"/>
                                            </Border>
                                            <StackPanel>
                                                <TextBlock Text="{x:Bind Date}" FontWeight="Bold" Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                                                <TextBlock Text="Examen Visual" FontSize="11" Foreground="{StaticResource SubtletyColor}"/>
                                            </StackPanel>
                                        </StackPanel>
                                        <Button Grid.Column="1" Click="EditExam_Click" Tag="{x:Bind}" Background="Transparent" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" CornerRadius="4" Padding="12,4" Height="32">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="Ver Ficha" FontSize="11" FontWeight="SemiBold"/>
                                                <FontIcon Glyph="&#xE76C;" FontSize="10"/>
                                            </StackPanel>
                                        </Button>
                                    </Grid>

                                    <Grid Grid.Row="1" Padding="20">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <TextBlock Text="DATOS REFRACTIVOS" Style="{StaticResource DetailLabel}" Foreground="{StaticResource BrandColor}" Margin="0,0,0,12"/>

                                        <Grid Grid.Row="1" ColumnSpacing="24">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>

                                            <Border Background="#F3F9FE" CornerRadius="8" Padding="12" BorderBrush="#E1F5FE" BorderThickness="1">
                                                <StackPanel>
                                                    <TextBlock Text="OD (DERECHO)" FontSize="10" FontWeight="Bold" Foreground="{StaticResource BrandColor}" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                                    <Grid ColumnSpacing="4">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <Border Style="{StaticResource RefractionBox}">
                                                            <StackPanel>
                                                                <TextBlock Text="ESF" FontSize="9" HorizontalAlignment="Center" Opacity="0.6"/>
                                                                <TextBlock Text="{x:Bind SphereOD}" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Grid.Column="1" Style="{StaticResource RefractionBox}">
                                                            <StackPanel>
                                                                <TextBlock Text="CIL" FontSize="9" HorizontalAlignment="Center" Opacity="0.6"/>
                                                                <TextBlock Text="{x:Bind CylOD}" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Grid.Column="2" Style="{StaticResource RefractionBox}">
                                                            <StackPanel>
                                                                <TextBlock Text="EJE" FontSize="9" HorizontalAlignment="Center" Opacity="0.6"/>
                                                                <TextBlock Text="{x:Bind AxisOD}" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Grid.Column="3" Style="{StaticResource RefractionBox}" Background="White" BorderBrush="{StaticResource BrandColor}" BorderThickness="1">
                                                            <StackPanel>
                                                                <TextBlock Text="A.V." FontSize="9" HorizontalAlignment="Center" Foreground="{StaticResource BrandColor}"/>
                                                                <TextBlock Text="{x:Bind AvOD}" FontWeight="Bold" HorizontalAlignment="Center" Foreground="{StaticResource BrandColor}"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </Grid>
                                                </StackPanel>
                                            </Border>

                                            <Border Grid.Column="1" Background="#E0F2F1" CornerRadius="8" Padding="12" BorderBrush="#B2DFDB" BorderThickness="1">
                                                <StackPanel>
                                                    <TextBlock Text="OI (IZQUIERDO)" FontSize="10" FontWeight="Bold" Foreground="{StaticResource SuccessColor}" HorizontalAlignment="Center" Margin="0,0,0,8"/>
                                                    <Grid ColumnSpacing="4">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <Border Style="{StaticResource RefractionBox}">
                                                            <StackPanel>
                                                                <TextBlock Text="ESF" FontSize="9" HorizontalAlignment="Center" Opacity="0.6"/>
                                                                <TextBlock Text="{x:Bind SphereOI}" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Grid.Column="1" Style="{StaticResource RefractionBox}">
                                                            <StackPanel>
                                                                <TextBlock Text="CIL" FontSize="9" HorizontalAlignment="Center" Opacity="0.6"/>
                                                                <TextBlock Text="{x:Bind CylOI}" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Grid.Column="2" Style="{StaticResource RefractionBox}">
                                                            <StackPanel>
                                                                <TextBlock Text="EJE" FontSize="9" HorizontalAlignment="Center" Opacity="0.6"/>
                                                                <TextBlock Text="{x:Bind AxisOI}" FontWeight="Bold" HorizontalAlignment="Center"/>
                                                            </StackPanel>
                                                        </Border>
                                                        <Border Grid.Column="3" Style="{StaticResource RefractionBox}" Background="White" BorderBrush="{StaticResource SuccessColor}" BorderThickness="1">
                                                            <StackPanel>
                                                                <TextBlock Text="A.V." FontSize="9" HorizontalAlignment="Center" Foreground="{StaticResource SuccessColor}"/>
                                                                <TextBlock Text="{x:Bind AvOI}" FontWeight="Bold" HorizontalAlignment="Center" Foreground="{StaticResource SuccessColor}"/>
                                                            </StackPanel>
                                                        </Border>
                                                    </Grid>
                                                </StackPanel>
                                            </Border>
                                        </Grid>
                                    </Grid>

                                    <Border Grid.Row="2" Background="#FFFDE7" Padding="20,12" CornerRadius="0,0,12,12" BorderBrush="#FFF9C4" BorderThickness="0,1,0,0">
                                        <StackPanel>
                                            <TextBlock Text="DIAGNÓSTICO Y NOTAS" Style="{StaticResource DetailLabel}" Foreground="{StaticResource WarningColor}"/>
                                            <TextBlock Text="{x:Bind DiagnosticoResumen}" FontWeight="Bold" FontSize="13"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <Grid Margin="0,0,0,12">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                        <FontIcon Glyph="&#xE8A1;" Foreground="{StaticResource SubtletyColor}" FontSize="18" VerticalAlignment="Center"/>
                        <TextBlock Text="Pedidos y Ventas" Style="{StaticResource HeaderTitle}" Margin="0"/>
                    </StackPanel>
                    <TextBlock Grid.Column="1" Text="Sin pedidos" Foreground="{StaticResource SubtletyColor}" Visibility="{x:Bind ShowIfEmpty(CurrentPatient.OrderHistory.Count), Mode=OneWay}" VerticalAlignment="Center"/>
                </Grid>

                <ListView ItemsSource="{x:Bind CurrentPatient.OrderHistory, Mode=OneWay}" SelectionMode="None">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Padding" Value="0"/>
                            <Setter Property="Margin" Value="0,0,0,8"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate x:DataType="models:Order">
                            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1" Padding="0">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="6"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="140"/>
                                    </Grid.ColumnDefinitions>

                                    <Rectangle Fill="{StaticResource BrandColor}"/>

                                    <StackPanel Grid.Column="1" Padding="16,12">
                                        <StackPanel Orientation="Horizontal" Spacing="10" Margin="0,0,0,4">
                                            <TextBlock Text="{x:Bind FrameModel}" FontWeight="Bold" FontSize="15"/>
                                            <Border Background="{ThemeResource LayerFillColorDefaultBrush}" CornerRadius="4" Padding="6,2">
                                                <TextBlock Text="{x:Bind Status}" FontSize="11" Foreground="{StaticResource SubtletyColor}" FontWeight="Bold"/>
                                            </Border>
                                        </StackPanel>
                                        <TextBlock Text="{x:Bind LensType}" FontSize="13" Foreground="{StaticResource SubtletyColor}"/>
                                        <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,4,0,0" Opacity="0.7">
                                            <FontIcon Glyph="&#xE787;" FontSize="10"/>
                                            <TextBlock Text="{x:Bind Date}" FontSize="11"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <StackPanel Grid.Column="2" VerticalAlignment="Center" Margin="0,0,24,0">
                                        <TextBlock Text="PENDIENTE" FontSize="10" FontWeight="Bold" Foreground="{StaticResource SubtletyColor}" HorizontalAlignment="Right"/>
                                        <TextBlock Text="{x:Bind Balance}" FontSize="14" FontWeight="Bold" Foreground="{StaticResource WarningColor}" HorizontalAlignment="Right"/>
                                    </StackPanel>

                                    <Border Grid.Column="3" Background="#F1F8E9" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}" BorderThickness="1,0,0,0" Padding="0" CornerRadius="0,8,8,0">
                                        <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                            <TextBlock Text="TOTAL" FontSize="10" FontWeight="Bold" Foreground="{StaticResource SuccessColor}" HorizontalAlignment="Center"/>
                                            <TextBlock Text="{x:Bind TotalAmount}" FontSize="18" FontWeight="Bold" Foreground="{StaticResource SuccessColor}" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>

                <Rectangle Height="100"/>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</Page>